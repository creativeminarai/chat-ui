<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee & Bakery Arles - Forest RPG</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2XZ44ZXK49"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-2XZ44ZXK49');
    </script>
    <style>
        :root {
            --nat-green: #5a7d5a;
            --nat-brown: #3e2723;
            --nat-beige: #fdf5e6;
            --nat-window: rgba(255, 255, 255, 0.98);
            --nat-border: #8b7355;
            --nat-highlight: #c05d1d;
            --font-main: 'Zen Maru Gothic', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background-color: #f8f4ed;
            color: var(--nat-brown);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overflow-y: auto;
            position: relative;
            letter-spacing: 0.02em;
        }

        .bg-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background-size: cover;
            background-position: center;
            transition: opacity 2s ease-in-out;
            will-change: opacity;
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: rgba(248, 244, 237, 0.35);
            pointer-events: none;
        }

        body::after {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.25) 0%, transparent 40%);
            pointer-events: none;
            z-index: 10;
            animation: lightMove 20s linear infinite alternate;
        }

        @keyframes lightMove {
            0% {
                transform: translate(0, 0);
                opacity: 0.5;
            }

            100% {
                transform: translate(5%, 5%);
                opacity: 0.8;
            }
        }

        .bg-back {
            opacity: 0;
        }

        .bg-front {
            opacity: 1;
        }

        .bg-front.fade-out {
            opacity: 0;
        }

        header {
            padding: 12px;
            text-align: center;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10;
            border-bottom: 2px solid var(--nat-border);
            position: sticky;
            top: 0;
        }

        header h1 {
            font-size: 0.95rem;
            color: var(--nat-green);
            letter-spacing: 0.15em;
            font-weight: 700;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 5;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .staff-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 25px;
            animation: fadeIn 0.8s ease-out;
        }

        .avatar-container {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            border: 5px solid var(--nat-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            background: #fff;
            animation: breathe 4s ease-in-out infinite;
            transform-origin: bottom center;
        }

        @keyframes breathe {

            0%,
            100% {
                transform: scale(1) translateY(0);
            }

            50% {
                transform: scale(1.02) translateY(-5px);
            }
        }

        .avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .nameplate {
            background: var(--nat-green);
            color: #fff;
            padding: 4px 20px;
            border: 2px solid var(--nat-border);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-top: -12px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        /* ÁîªÂÉèË°®Á§∫„Ç®„É™„Ç¢Ôºö‰ªïÁµÑ„Åø„ÅØÊÆã„Åô„ÅåÂàùÊúüÁä∂ÊÖã„ÅØÈùûË°®Á§∫ */
        .display-area {
            width: 100%;
            max-width: 480px;
            margin: 15px auto;
            border: 4px solid var(--nat-border);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            display: none;
            animation: fadeIn 0.5s ease-out;
            position: relative;
            aspect-ratio: 16 / 10;
        }

        .display-area img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.5s;
        }

        .speech-bubble {
            background: var(--nat-window);
            padding: 24px 30px;
            border: 4px solid var(--nat-border);
            border-radius: 14px;
            width: 100%;
            max-width: 620px;
            margin: 0 auto 20px;
            font-size: 1.05rem;
            font-weight: 500;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            word-break: break-all;
            contain: layout;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            top: -14px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 14px solid transparent;
            border-right: 14px solid transparent;
            border-bottom: 14px solid var(--nat-border);
        }

        .highlight {
            color: var(--nat-highlight);
            font-weight: 700;
            background: linear-gradient(transparent 80%, rgba(192, 93, 29, 0.1) 80%);
        }

        .choices-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 40px;
            width: 100%;
            max-width: 440px;
            margin: 0 auto;
        }

        .choice-btn {
            background: var(--nat-green);
            border: none;
            border-bottom: 4px solid #3d5a3d;
            padding: 16px 24px;
            font-family: var(--font-main);
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            width: 100%;
        }

        .choice-btn:hover {
            background: #6a8d6a;
            transform: translateY(2px);
            border-bottom-width: 2px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .choice-btn:active {
            transform: translateY(4px);
            border-bottom-width: 0;
            box-shadow: none;
        }

        .choice-btn::before {
            content: 'üå±';
            margin-right: 8px;
            font-size: 1.1rem;
            transition: transform 0.3s;
        }

        .choice-btn:hover::before {
            transform: scale(1.2) rotate(10deg);
        }

        @keyframes jump {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .choice-btn:active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(90, 125, 90, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(2);
            animation: ripple 0.4s ease-out;
        }

        @keyframes ripple {
            to {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .next-indicator {
            position: absolute;
            bottom: 10px;
            right: 15px;
            font-size: 0.9rem;
            color: var(--nat-green);
            animation: bounce 1.2s infinite;
            display: none;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
                opacity: 0.5;
            }

            50% {
                transform: translateY(-4px);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="bg-layer bg-back" id="bg-back"></div>
    <div class="bg-layer bg-front" id="bg-front"></div>
    <div class="bg-overlay"></div>

    <header>
        <h1>~ Coffee & Bakery Arles ~</h1>
    </header>

    <main>
        <div class="staff-section">
            <div class="avatar-container">
                <img src="tenshu002.jpg" alt="„Éë„É≥ËÅ∑‰∫∫">
            </div>
            <div class="nameplate">„Äê„Éë„É≥ËÅ∑‰∫∫„Äë</div>
        </div>

        <!-- Â±ïÁ§∫„Ç®„É™„Ç¢ÔºöÂ∞ÜÊù•„ÅÆ„Åü„ÇÅ„Å´HTMLÊßãÈÄ†„ÅØÊÆã„Åô„Åå„ÄÅCSS/JS„ÅßÈùûË°®Á§∫ -->
        <div class="display-area" id="display-area">
            <img id="display-image" src="" alt="Á¥π‰ªãÁîªÂÉè">
        </div>

        <div class="speech-bubble">
            <div id="chat-text"></div>
            <div class="next-indicator" id="next-indicator">‚ñº</div>
        </div>

        <div class="choices-section" id="choices-container">
            <!-- JavaScript„ÅßÁîüÊàê -->
        </div>
    </main>

    <script src="./chat-data.js" charset="UTF-8"></script>
    <script>


        const CONFIG = { typingSpeed: 25 };
        const chatTextElement = document.getElementById('chat-text');
        const choicesContainer = document.getElementById('choices-container');
        const nextIndicator = document.getElementById('next-indicator');
        const displayArea = document.getElementById('display-area');
        const displayImage = document.getElementById('display-image');
        const staffAvatar = document.querySelector('.avatar-container img');
        const namePlate = document.querySelector('.nameplate');
        const bgFront = document.getElementById('bg-front');
        const bgBack = document.getElementById('bg-back');

        const BACKGROUNDS = ['shop_inside001.jpg', 'shop_inside002.jpg', 'shop_inside003.jpg'];
        let currentBgIndex = 0;
        let isTyping = false;
        let lipSyncTimer = null;

        // Ë°®ÊÉÖÁîªÂÉè„ÅÆÂÆöÁæ©„ÄÇÁèæÂú®„ÅØÂÖ®„Å¶Âêå„ÅòÁîªÂÉè(tenshu002.jpg„ÅÆ„Ç≥„Éî„Éº)„Å´Ë®≠ÂÆö
        const EXPRESSIONS = {
            tenshu: {
                base: 'tenshu_base.jpg',
                blink: 'tenshu_blink.jpg',
                talk: 'tenshu_talk.jpg'
            },
            cat: {
                base: 'cat_icon.jpg',
                blink: 'cat_icon.jpg',
                talk: 'cat_icon.jpg'
            }
        };

        let currentSpeaker = 'tenshu';

        function setBgImage(el, imageUrl) {
            el.style.backgroundImage = `url('${imageUrl}')`;
        }
        setBgImage(bgFront, BACKGROUNDS[0]);

        function rotateBackground() {
            const nextIndex = (currentBgIndex + 1) % BACKGROUNDS.length;
            setBgImage(bgBack, BACKGROUNDS[nextIndex]);
            bgBack.style.opacity = 1;
            bgFront.classList.add('fade-out');

            setTimeout(() => {
                setBgImage(bgFront, BACKGROUNDS[nextIndex]);
                bgFront.classList.remove('fade-out');
                bgBack.style.opacity = 0;
                currentBgIndex = nextIndex;
            }, 2050);
        }
        setInterval(rotateBackground, 15000);

        // „Åæ„Å∞„Åü„Åç„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function startBlinking() {
            const blink = () => {
                if (!isTyping) {
                    staffAvatar.src = EXPRESSIONS[currentSpeaker].blink;
                    setTimeout(() => {
                        if (!isTyping) staffAvatar.src = EXPRESSIONS[currentSpeaker].base;
                    }, 150);
                }
                setTimeout(blink, Math.random() * 3000 + 2000);
            };
            setTimeout(blink, 2000);
        }
        startBlinking();

        // Âè£„Éë„ÇØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function startLipSync() {
            if (lipSyncTimer) return;
            lipSyncTimer = setInterval(() => {
                const currentSrc = staffAvatar.src.split('/').pop();
                staffAvatar.src = currentSrc === EXPRESSIONS[currentSpeaker].base ?
                    EXPRESSIONS[currentSpeaker].talk :
                    EXPRESSIONS[currentSpeaker].base;
            }, 200);
        }

        function stopLipSync() {
            if (lipSyncTimer) {
                clearInterval(lipSyncTimer);
                lipSyncTimer = null;
            }
            staffAvatar.src = EXPRESSIONS[currentSpeaker].base;
        }

        let currentMessageId = 0;
        let typingRequest = null;

        async function displayMessage(text, imageUrl) {
            const messageId = ++currentMessageId;
            isTyping = true;
            chatTextElement.innerHTML = '';
            nextIndicator.style.display = 'none';
            if (currentSpeaker === 'tenshu') startLipSync();

            if (imageUrl) {
                displayImage.style.opacity = 0;
                displayImage.src = imageUrl;
                displayArea.style.display = 'block';
                setTimeout(() => { if (messageId === currentMessageId) displayImage.style.opacity = 1; }, 50);
            } else {
                displayArea.style.display = 'none';
            }

            return new Promise((resolve) => {
                let i = 0;
                let lastTime = 0;
                let currentTarget = chatTextElement;

                function type(time) {
                    if (messageId !== currentMessageId) return; // Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÂßã„Åæ„Å£„Åü„ÇâÂÅúÊ≠¢

                    if (!lastTime) lastTime = time;
                    const delta = time - lastTime;

                    if (delta >= CONFIG.typingSpeed) {
                        if (i < text.length) {
                            if (text.substring(i, i + 2) === '[[') {
                                const span = document.createElement('span');
                                span.className = 'highlight';
                                chatTextElement.appendChild(span);
                                currentTarget = span;
                                i += 2;
                                lastTime = time; // Âá¶ÁêÜÊôÇÈñì„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶Ê¨°„Å´Âõû„Åô
                                typingRequest = requestAnimationFrame(type);
                                return;
                            } else if (text.substring(i, i + 2) === ']]') {
                                currentTarget = chatTextElement;
                                i += 2;
                                lastTime = time; // Âá¶ÁêÜÊôÇÈñì„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶Ê¨°„Å´Âõû„Åô
                                typingRequest = requestAnimationFrame(type);
                                return;
                            } else {
                                currentTarget.appendChild(document.createTextNode(text[i]));
                                i++;
                            }
                            lastTime = time;
                        } else {
                            isTyping = false;
                            stopLipSync();
                            nextIndicator.style.display = 'block';
                            resolve();
                            return;
                        }
                    }
                    typingRequest = requestAnimationFrame(type);
                }
                typingRequest = requestAnimationFrame(type);
            });
        }

        function renderChoices(options) {
            choicesContainer.innerHTML = '';
            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = opt.text;
                btn.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
                btn.onclick = () => {
                    if (isTyping) return;
                    navigateToState(opt.next);
                };
                choicesContainer.appendChild(btn);
            });
        }

        async function navigateToState(stateKey) {
            const state = window.chatScenarios[stateKey] || window.chatScenarios['start'];

            // „Ç≠„É£„É©„ÇØ„Çø„ÉºÂàá„ÇäÊõø„Åà„ÅÆÂæ©ÂÖÉ
            currentSpeaker = state.speaker === 'cat' ? 'cat' : 'tenshu';
            staffAvatar.src = EXPRESSIONS[currentSpeaker].base;
            namePlate.textContent = currentSpeaker === 'cat' ? '„ÄêÁúãÊùøÁå´„Äë' : '„Äê„Éë„É≥ËÅ∑‰∫∫„Éª‰∏≠Â∑ù„Äë';

            choicesContainer.style.opacity = '0';
            choicesContainer.style.pointerEvents = 'none';
            await displayMessage(state.text, state.image);
            renderChoices(state.options);
            choicesContainer.style.opacity = '1';
            choicesContainer.style.pointerEvents = 'auto';
        }

        // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´„ÉÅ„É£„ÉÉ„Éà„ÇíÈñãÂßã
        window.addEventListener('DOMContentLoaded', () => {
            if (window.chatScenarios) navigateToState('start');
        });
    </script>
</body>

</html>